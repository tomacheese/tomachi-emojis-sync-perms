# CLAUDE.md

## 目的
このドキュメントは、Claude Code の作業方針とプロジェクト固有ルールを示す。

## 判断記録のルール
1. 判断内容の要約を記載する
2. 検討した代替案を列挙する
3. 採用しなかった案とその理由を明記する
4. 前提条件・仮定・不確実性を明示する
5. 他エージェントによるレビュー可否を示す

前提・仮定・不確実性を明示し、仮定を事実のように扱わない。

## プロジェクト概要
- 目的: Discord サーバー間でのロール権限同期（Tomachi Emojis 用）
- 主な機能: ソースサーバーのロール保持状況を監視し、設定された複数の宛先サーバーに対してロールを同期する。

## 重要ルール
- 会話と言語: 日本語を使用する。
- コメント言語: 日本語を使用する。
- エラーメッセージ言語: 英語を使用する。
- コミット規約: [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) に従い、`<description>` は日本語で記載する。
- 日本語と英数字の間: 半角スペースを挿入する。

## 環境のルール
- ブランチ命名: [Conventional Branch](https://conventional-branch.github.io) に従い、短縮形（feat, fix）を使用する。
- GitHub リポジトリ調査方法: テンポラリディレクトリに git clone して検索する。
- Renovate PR: 追加コミットや更新を行わない。

## コード改修時のルール
- エラーメッセージの絵文字統一: 既存の形式に合わせ、エラー内容に即した絵文字を使用する。
- TypeScript: `skipLibCheck` による回避を禁止する。
- docstring: 関数・インターフェースに日本語で記載する。

## 相談ルール
- Codex CLI: 実装レビュー、局所設計、整合性確認。
- Gemini CLI: 外部仕様、最新情報確認。
- 指摘への対応: 信頼度スコアが 50 以上の指摘には必ず対応する。

## 開発コマンド
```bash
# インストール
pnpm install

# ビルド（コンパイル）
pnpm compile

# 実行
pnpm start

# 開発
pnpm dev

# テスト
pnpm test

# Lint
pnpm lint

# 修正
pnpm fix
```

## アーキテクチャと主要ファイル
- `src/main.ts`: エントリーポイント。ボットの起動と終了処理を管理。
- `src/config.ts`: `data/config.json` の設定管理。
- `src/discord.ts`: Discord クライアントの挙動、ロール同期のメインロジック。
- `src/linking.ts`: `data/linking.yml` のパースと同期設定の保持。

## 実装パターン
- `@book000/node-utils` のユーティリティ（Logger, ConfigFramework）を基盤として使用する。

## テスト
- Jest を使用する。
- `src/*.test.ts` にテストコードを配置し、ロジックの正当性を保証する。

## ドキュメント更新ルール
- 設定形式の変更時は `README.md` や関連する型定義を更新する。

## 作業チェックリスト

### 新規改修時
1. プロジェクトを理解する
2. 作業ブランチが適切であることを確認する
3. 最新のリモートブランチに基づいた新規ブランチであることを確認する
4. PR がクローズされた不要ブランチが削除済みであることを確認する
5. 指定されたパッケージマネージャー（pnpm）で依存関係をインストールする

### コミット・プッシュ前
1. Conventional Commits に従っていることを確認する
2. センシティブな情報が含まれていないことを確認する
3. Lint / Format エラーがないことを確認する
4. 動作確認を行う

### PR 作成前
1. PR 作成の依頼があることを確認する
2. センシティブな情報が含まれていないことを確認する
3. コンフリクトの恐れがないことを確認する

### PR 作成後
1. コンフリクトがないことを確認する
2. PR 本文が最新状態のみを網羅していることを確認する
3. `gh pr checks <PR ID> --watch` で CI を確認する
4. Copilot レビューに対応し、コメントに返信する
5. Codex のコードレビューを実施し、指摘対応を行う
6. PR 本文の崩れがないことを確認する

## リポジトリ固有
- ロール同期は 10 分間隔（`Discord.onReady` 内の `setInterval`）で行われる。
- 同期設定は環境変数 `LINKING_PATH` で変更可能（デフォルト: `data/linking.yml`）。
